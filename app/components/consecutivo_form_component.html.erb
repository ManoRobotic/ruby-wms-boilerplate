<%# Shared form partial for creating/editing consecutivos %>
<%= form_with model: [:admin, production_order, consecutivo_form], 
    data: { 
      controller: "consecutivo-form", 
      turbo_stream: true,
      action: "turbo:submit-end->consecutivo-form#handleFormSubmit" 
    },
    local: false,
    format: :turbo_stream,
    class: "relative border-t border-slate-200 py-2" do |form| %>
    
    <div class="grid gap-2 mb-2">
        <!-- Folio Consecutivo -->
        <div>
            <label class="block mb-1 text-sm font-medium text-slate-700" for="production_order_item_folio_consecutivo">Folio Consecutivo</label>
            <div class="flex items-center gap-2">
                <%= form.text_field :folio_consecutivo, 
                    class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg block w-full p-2",
                    readonly: consecutivo_form.persisted? %>
            </div>
        </div>

        <!-- Product Name (Pre-filled with clave_producto) -->
        <div>
            <label for="clave_producto" class="block mb-1 text-sm font-medium text-slate-700">Clave Producto</label>
            <%= form.text_field :clave_producto_display, 
                name: "clave_producto_display",
                id: "clave_producto", 
                class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                value: production_order.clave_producto || "BOPPTRANS 35 / 420",
                placeholder: "BOPPTRANS 35 / 420",
                readonly: true %>
        </div>

        <!-- Control de modo de pesaje -->
        <div class="mb-3">
            <!-- Mensajes de modo -->
            <div data-consecutivo-form-target="scaleWeightSection">
                <!-- Mensaje cuando está en modo báscula (por defecto) -->
                <p class="text-sm text-[var(--color-bamboo-700)] bg-[var(--color-bamboo-50)] border border-[var(--color-bamboo-300)] rounded-md p-2 scale-mode-message">
                    <span class="font-medium">Modo Báscula Activo:</span> Use el control de pesaje abajo para obtener el peso automáticamente.
                </p>
                
                <!-- Mensaje cuando está en modo manual (oculto por defecto) -->
                <p class="text-sm text-[var(--color-blue-gem-700)] bg-[var(--color-blue-gem-500)] border border-[var(--color-blue-gem-200)] rounded-md p-2 manual-mode-message hidden">
                    <span class="font-medium">Modo de Uso:</span> Ingreso manual, ingrese peso del folio manualmente.
                </p>
            </div>
            
            <!-- Checkboxes for modes -->
            <div class="flex flex-row flex-wrap gap-4 mt-1 mb-2">
                <label class="flex items-center cursor-pointer p-1">
                    <input type="checkbox" 
                           id="manual_weight_checkbox"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           data-action="change->consecutivo-form#toggleManualMode"
                           data-consecutivo-form-target="manualModeCheckbox">
                    <span class="ml-2 text-sm font-medium text-gray-700 whitespace-nowrap">Ingresar peso manualmente</span>
                </label>

                <label class="flex items-center cursor-pointer p-1 rounded-md transition-colors <%= auto_print ? 'bg-emerald-50 border border-emerald-200' : '' %>">
                    <input type="checkbox" 
                           name="auto_print"
                           id="auto_print_checkbox"
                           value="1"
                           class="h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded"
                           data-action="change->consecutivo-form#toggleAutoPrint"
                           data-consecutivo-form-target="autoPrintCheckbox"
                           data-consecutivo-scale-target="autoPrintCheckbox"
                           <%= (auto_print || (helpers.current_admin || helpers.current_user)&.company&.auto_save_consecutivo) ? 'checked' : '' %>>
                    <span class="ml-2 text-sm font-medium text-gray-700 whitespace-nowrap">Impresión automática</span>
                    <% if auto_print %>
                        <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-800 animate-pulse">
                            MANOS LIBRES
                        </span>
                    <% end %>
                </label>
            </div>

            <!-- Input de peso manual (deshabilitado por defecto) -->
            <div data-consecutivo-form-target="manualWeightSection" class="hidden">
                <label class="block mb-1 text-sm font-medium text-slate-700 mt-4" for="production_order_item_peso_bruto_manual">Peso Bruto (kg)</label>
                <div class="flex items-center">
                    <%= form.number_field :peso_bruto_manual, 
                        class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                        placeholder: "0.00",
                        step: 0.01,
                        min: 0,
                        disabled: true,
                        data: { 
                          action: "input->consecutivo-form#calculateWeights",
                          "consecutivo-form-target": "pesoBrutoInput"
                        },
                        value: consecutivo_form.persisted? ? consecutivo_form.peso_bruto : nil %>
                </div>
                <p class="text-xs text-gray-600 mt-1">Ingrese el peso manualmente</p>
            </div>
        </div>

        <div class="bg-[var(--color-blue-gem-50)] rounded-md p-2 mb-2 transition-opacity duration-300" 
             data-controller="consecutivo-scale" 
             data-consecutivo-scale-auto-connect-value="true"
             data-consecutivo-scale-saved-port-value="<%= (helpers.current_admin || helpers.current_user)&.company&.serial_port || '' %>"
             data-consecutivo-scale-auto-save-value="<%= (helpers.current_admin || helpers.current_user)&.company&.auto_save_consecutivo || false %>"
             data-consecutivo-form-target="serialSection">
          <h4 class="font-medium text-[var(--color-blue-gem-900)] mb-1.5 text-sm">Control de Pesaje</h4>
          
          <!-- Status de Conexión -->
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-sm font-medium text-[var(--color-blue-gem-700)]">Estado:</span>
            <span data-consecutivo-scale-target="status" class="px-2 py-1 rounded text-xs font-medium bg-[var(--color-bamboo-100)] text-[var(--color-bamboo-400)]">Iniciando...</span>
          </div>

          <!-- Weight Display -->
          <div class="weight-section p-2 bg-white rounded-md border mb-2 border-[var(--color-blue-gem-200)]">
            <div class="flex items-center justify-between mb-1.5">
              <span class="font-medium text-[var(--color-blue-gem-700)] text-sm">Peso actual:</span>
              <div class="flex gap-1">
                <!-- Button removed for automatic reading -->
              </div>
            </div>
            <div data-consecutivo-scale-target="weight" class="weight-display">
              <div class="text-xl font-bold block text-center transition-all duration-300 ease-in-out text-[var(--color-blue-gem-400)]">--</div>
              <div class="text-xs text-[var(--color-blue-gem-500)] block text-center">--</div>
            </div>
          </div>
        </div>

        <!-- Campos calculados automáticamente -->
        <div class="bg-[var(--color-blue-gem-50)] rounded-md p-2 mb-2 border border-[var(--color-blue-gem-200)]">
            <h4 class="text-sm font-semibold text-[var(--color-blue-gem-900)] mb-1.5">Cálculos Automáticos</h4>
            
            <div class="grid grid-cols-2 gap-1.5">
                <!-- Peso Neto -->
                <div class="bg-white rounded p-1.5 border border-[var(--color-blue-gem-200)]">
                    <div class="text-xs text-[var(--color-blue-gem-700)] font-medium">Peso Neto</div>
                    <div class="text-sm font-bold text-[var(--color-blue-gem-900)]" data-consecutivo-form-target="pesoNetoDisplay">
                      <%= consecutivo_form.peso_neto ? "#{consecutivo_form.peso_neto.round(3)} kg" : "0.000 kg" %>
                    </div>
                    <%= form.hidden_field :peso_neto, data: { "consecutivo-form-target": "pesoNeto" } %>
                </div>

                <!-- Peso Core -->
                <div class="bg-white rounded p-1.5 border border-[var(--color-blue-gem-200)]">
                    <div class="text-xs text-[var(--color-blue-gem-700)] font-medium">Peso Core</div>
                    <div class="text-sm font-bold text-[var(--color-blue-gem-900)]" data-consecutivo-form-target="pesoCoreDisplay">
                      <%= consecutivo_form.peso_core_gramos ? "#{consecutivo_form.peso_core_gramos} g" : "200 g" %>
                    </div>
                </div>

                <!-- Metros Lineales -->
                <div class="bg-white rounded p-1.5 border border-[var(--color-blue-gem-200)]">
                    <div class="text-xs text-[var(--color-blue-gem-700)] font-medium">Metros Lineales</div>
                    <div class="text-sm font-bold text-[var(--color-blue-gem-900)]" data-consecutivo-form-target="metrosLinealesDisplay">
                      <%= consecutivo_form.metros_lineales ? "#{consecutivo_form.metros_lineales.round(4)} m" : "0.0000 m" %>
                    </div>
                    <%= form.hidden_field :metros_lineales, data: { "consecutivo-form-target": "metrosLineales" } %>
                </div>

                <!-- Especificaciones -->
                <div class="bg-white rounded p-1.5 border border-[var(--color-blue-gem-200)]">
                    <div class="text-xs text-[var(--color-blue-gem-700)] font-medium">Especificaciones</div>
                    <div class="text-xs font-semibold text-[var(--color-blue-gem-900)]" data-consecutivo-form-target="especificacionesDisplay">
                      <%= "#{consecutivo_form.micras || 35}μ / #{consecutivo_form.ancho_mm || 420}mm" %>
                    </div>
                    <%= form.hidden_field :micras, value: consecutivo_form.micras || 35 %>
                    <%= form.hidden_field :ancho_mm, value: consecutivo_form.ancho_mm || 420 %>
                </div>
            </div>

            <div class="text-xs text-[var(--color-blue-gem-700)] mt-1.5 opacity-75">
                Los cálculos se actualizan automáticamente al ingresar el peso bruto
            </div>
        </div>

        
    </div>

    <!-- Hidden fields for calculated values -->
    <%= form.hidden_field :peso_core_gramos %>
    <%= form.hidden_field :altura_cm, value: 75 %>
    <%= form.hidden_field :peso_bruto, data: { "consecutivo-form-target": "pesoBrutoHidden" } %>
    <%= form.hidden_field :peso_bruto_manual, data: { "consecutivo-form-target": "pesoBrutoManualHidden" } %>
    
    <!-- Form buttons -->
    <div class="flex shrink-0 flex-wrap items-center pt-2 justify-end border-t border-slate-200">
      <button 
        data-dialog-close="true" 
        type="button"
        class="rounded-md border border-transparent py-1 px-2.5 text-center text-sm transition-all text-slate-600 hover:bg-slate-100 focus:bg-slate-100 active:bg-slate-100 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none">
        Cancelar
      </button>
      <%= form.submit consecutivo_form.persisted? ? "Guardar Consecutivo" : "Crear Consecutivo", 
          class: "rounded-md bg-[var(--color-dark-fern-600)] py-1 px-2.5 border border-transparent text-center text-sm text-white transition-all shadow hover:shadow focus:bg-[var(--color-dark-fern-700)] focus:shadow-none active:bg-[var(--color-dark-fern-700)] hover:bg-[var(--color-dark-fern-700)] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none ml-1.5",
          data: { "form-validation-target": "submit" } %>
    </div>
<% end %>
