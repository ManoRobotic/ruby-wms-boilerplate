<% if notice.present? %>
  <%= render "shared/succes_alert", notice: notice %>
<% end %>

<div class="w-full px-1 mt-12 mb-16 min-h-screen flex flex-col" style="max-width: calc(100% - 0.75rem); margin-right: 0;" data-responsive-right-margin="true">
  <!-- Vista de Admin -->
  <div class="relative flex flex-col w-full px-6 text-gray-700 bg-white shadow-md lg:px-10 rounded-xl bg-clip-border flex-1">
    <div class="relative mx-4 mt-4 mb-8 overflow-hidden text-gray-700 bg-white rounded-none bg-clip-border">
      <div class="flex flex-col items-center justify-between gap-8 mb-4 md:flex-row md:items-center">
        <div>
          <h2 class="block mt-12 text-xl font-semibold text-center text-blue-gray-900 md:text-left">
            <%= t('admin.dashboard.sales_summary') %>
          </h2>
        </div>
      </div>
    </div>

    <!-- WMS Dashboard Section - Show to supervisors and admins -->
    <% if current_admin || current_user&.can?('read_admin_dashboard') %>
    <div class="px-4 overflow-auto mb-8">
      <h2 class="mb-4 text-2xl font-medium text-gray-800">Estado del Sistema WMS</h2>
      <div class="grid w-full gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <% wms_stats = [
          { title: 'Valor Total Inventario', value: @wms_metrics ? number_to_currency(@wms_metrics[:total_inventory_value] || 0) : '$0.00', icon: 'üí∞' },
          { title: 'Ubicaciones Activas', value: @wms_metrics ? number_with_delimiter(@wms_metrics[:total_locations] || 0) : '0', icon: 'üìç' },
          { title: 'Tareas Pendientes', value: @task_metrics ? (@task_metrics[:pending] || 0) : 0, icon: 'üìã', alert: @task_metrics && @task_metrics[:overdue] > 0 },
          { title: 'Pick Lists Activas', value: @pick_list_metrics ? (@pick_list_metrics[:in_progress] || 0) : 0, icon: 'üì¶' },
          { title: 'Productos Stock Bajo', value: @inventory_alerts ? (@inventory_alerts[:low_stock] || 0) : 0, icon: '‚ö†Ô∏è', alert: true },
          { title: 'Productos Vencidos', value: @inventory_alerts ? (@inventory_alerts[:expired] || 0) : 0, icon: 'üî¥', alert: true },
        ] %>
        <% wms_stats.each do |stat| %>
          <div class="relative flex flex-col w-full bg-white border rounded-lg shadow-sm <%= stat[:alert] && stat[:value].to_i > 0 ? 'border-red-300 bg-red-50' : 'border-slate-200' %>">
            <div class="px-1 pt-3 pb-2 mx-3 mb-0 border-b border-slate-200">
              <span class="text-sm font-medium text-slate-600">
                <%= stat[:icon] %> <%= stat[:title] %>
              </span>
            </div>
            <div class="p-4">
              <p class="mb-2 text-xl font-semibold <%= stat[:alert] && stat[:value].to_i > 0 ? 'text-red-800' : 'text-slate-800' %>">
                <%= stat[:value] %>
              </p>
              <p class="font-light leading-normal text-slate-600">
                Estado actual del sistema WMS.
              </p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>


    <!-- Tabla de Ganancias - Show only to admins -->
    <% if current_admin %>
    <div class="w-full align-left mb-16 mt-2" style="max-width: 85%">
      <h2 class="text-2xl font-medium text-gray-800 "><%= t('admin.dashboard.revenue') %></h2>
      <div class="relative w-full" data-controller="dashboard" data-dashboard-revenue-value="<%= @revenue_by_day_chart.to_json %>">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
    <% end %>
    
    <!-- Warehouse Utilization - Show to supervisors and admins -->
    <% if (current_admin || current_user&.can?('read_warehouse')) && @warehouse_utilization && @warehouse_utilization.any? %>
    <div class="px-4 overflow-auto mb-8">
      <h2 class="mb-4 text-2xl font-medium text-gray-800">Utilizaci√≥n de Almacenes</h2>
      <div class="grid w-full gap-4 sm:grid-cols-1 md:grid-cols-2">
        <% @warehouse_utilization.each do |warehouse| %>
          <div class="relative flex flex-col w-full bg-white border rounded-lg shadow-sm border-slate-200">
            <div class="px-4 pt-4 pb-2">
              <h3 class="text-lg font-medium text-slate-800"><%= warehouse[:name] %></h3>
              <div class="mt-2">
                <div class="flex justify-between text-sm text-slate-600 mb-1">
                  <span>Utilizaci√≥n</span>
                  <span><%= warehouse[:utilization] %>%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div class="<%= warehouse[:utilization] > 80 ? 'bg-red-500' : warehouse[:utilization] > 60 ? 'bg-yellow-500' : 'bg-green-500' %> h-2.5 rounded-full" style="width: <%= warehouse[:utilization] %>%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-500 mt-1">
                  <span>Disponibles: <%= warehouse[:available_locations] %></span>
                  <span>Total: <%= warehouse[:total_locations] %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>
    
    <!-- Recent Transactions - Show to users with inventory permissions -->
    <% if (current_admin || current_user&.can?('read_inventory')) && @recent_transactions && @recent_transactions.any? %>
    <div class="px-4 overflow-auto mb-8">
      <h2 class="mb-4 text-2xl font-medium text-gray-800">Transacciones Recientes</h2>
      <div class="bg-white border rounded-lg shadow-sm border-slate-200">
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto min-w-max">
            <thead>
              <tr class="border-b border-slate-200">
                <th class="p-4 text-sm font-medium text-slate-700">Tipo</th>
                <th class="p-4 text-sm font-medium text-slate-700">Producto</th>
                <th class="p-4 text-sm font-medium text-slate-700">Cantidad</th>
                <th class="p-4 text-sm font-medium text-slate-700">Ubicaci√≥n</th>
                <th class="p-4 text-sm font-medium text-slate-700">Fecha</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_transactions.each do |transaction| %>
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                  <td class="p-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= transaction.is_inbound? ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                      <%= transaction.transaction_type.humanize %>
                    </span>
                  </td>
                  <td class="p-4 text-sm text-slate-700"><%= transaction.product.name %></td>
                  <td class="p-4 text-sm <%= transaction.quantity > 0 ? 'text-green-600' : 'text-red-600' %>"><%=transaction.quantity > 0 ? '+' : '' %><%= transaction.quantity %></td>
                  <td class="p-4 text-sm text-slate-700"><%= transaction.location&.coordinate_code || 'N/A' %></td>
                  <td class="p-4 text-sm text-slate-500"><%= time_ago_in_words(transaction.created_at) %> ago</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <% end %>
    
    <!-- Picker Dashboard - Show only to pickers -->
    <% if current_user&.picker? %>
    <div class="px-4 overflow-auto mb-8">
      <h2 class="mb-4 text-2xl font-medium text-gray-800">Mi Panel de Picking</h2>
      <div class="grid w-full gap-6 sm:grid-cols-2 md:grid-cols-3">
        <% picker_stats = [
          { title: 'Mis Tareas Pendientes', value: @task_metrics ? (@task_metrics[:my_tasks] || 0) : 0, icon: 'üìã', link: admin_tasks_path },
          { title: 'Pick Lists Asignadas', value: current_user.pick_lists.where(status: ['pending', 'assigned', 'in_progress']).count, icon: 'üì¶', link: admin_pick_lists_path },
          { title: 'Completadas Hoy', value: (@task_metrics ? (@task_metrics[:completed_today] || 0) : 0) + (current_user.pick_lists.completed.where(completed_at: Date.current.beginning_of_day..Date.current.end_of_day).count), icon: '‚úÖ' }
        ] %>
        <% picker_stats.each do |stat| %>
          <div class="relative flex flex-col w-full bg-white border rounded-lg shadow-sm border-slate-200">
            <div class="px-1 pt-3 pb-2 mx-3 mb-0 border-b border-slate-200">
              <span class="text-sm font-medium text-slate-600">
                <%= stat[:icon] %> <%= stat[:title] %>
              </span>
            </div>
            <div class="p-4">
              <p class="mb-2 text-xl font-semibold text-slate-800">
                <%= stat[:value] %>
              </p>
              <% if stat[:link] %>
                <%= link_to "Ver todas", stat[:link], class: "text-blue-600 hover:text-blue-800 text-sm font-medium" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>
    
    <!-- Original E-commerce Stats - Show to admins and supervisors -->
    <% if current_admin || current_user&.can?('read_orders') %>
    <div class="px-4 overflow-auto mb-8">
      <h2 class="mb-4 text-2xl font-medium text-gray-800"><%= t('admin.dashboard.daily_status') %></h2>
      <div class="grid w-full gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <% stats = [
          { title: t('admin.dashboard.revenue'), value: @quick_stats[:revenue] ? number_to_currency(@quick_stats[:revenue]) : '$0.00' },
          { title: t('admin.dashboard.total_sales'), value: @quick_stats[:sales] ? number_to_currency(@quick_stats[:sales]) : '$0.00' },
          { title: t('admin.dashboard.avg_sale'), value: @quick_stats[:avg_sale] ? number_to_currency(@quick_stats[:avg_sale]) : '$0.00' },
          { title: t('admin.dashboard.items_per_sale'), value: @quick_stats[:per_sale].to_i }
        ] %>
        <% stats.each do |stat| %>
          <div class="relative flex flex-col w-full bg-white border rounded-lg shadow-sm border-slate-200">
            <div class="px-1 pt-3 pb-2 mx-3 mb-0 border-b border-slate-200">
              <span class="text-sm font-medium text-slate-600">
                <%= stat[:title] %>
              </span>
            </div>
            <div class="p-4">
              <p class="mb-2 text-xl font-semibold text-slate-800">
                <%= stat[:value] %>
              </p>
              <p class="font-light leading-normal text-slate-600">
                <%= t('admin.dashboard.relevant_data') %> <%= stat[:title] %>.
              </p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>
    </div>
  </div>
</div>
<style>
@media (min-width: 768px) {
  [data-responsive-right-margin="true"] {
    max-width: calc(100% - 0.75rem) !important;
  }
}
@media (max-width: 767px) {
  [data-responsive-right-margin="true"] {
    max-width: 100% !important;
  }
}
</style>
