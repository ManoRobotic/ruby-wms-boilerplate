<% if @production_order.errors.any? %>
  <div class="bg-red-50 border border-red-300 rounded-lg p-4 mb-6">
    <div class="flex">
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">
          Se encontraron los siguientes errores:
        </h3>
        <div class="mt-2 text-sm text-red-700">
          <ul class="list-disc list-inside space-y-1">
            <% @production_order.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
<% end %>

<div class="w-full px-1 mt-12 mb-16 min-h-screen flex flex-col" data-controller="production-order-form" data-responsive-right-margin="true">
  <div class="relative flex flex-col w-full px-6 text-gray-700 bg-white shadow-md lg:px-10 rounded-xl bg-clip-border flex-1">
    <div class="relative p-4 lg:p-8 text-gray-700 bg-white bg-clip-border mt-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Nueva Orden de Producción</h1>
        <%= link_to admin_production_orders_path, 
            class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
          <%= icon('fa-solid', 'arrow-left', class: 'w-4 h-4 mr-2') %>
          Volver
        <% end %>
      </div>

            <%= form_with model: [:admin, @production_order], local: false, class: "space-y-8" do |form| %>
        
        <!-- Production Details Card -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalles de la Orden</h3>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              
              <div>
                <%= form.label :warehouse_id, "Almacén", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.select :warehouse_id, 
                    options_from_collection_for_select(current_admin.company.warehouses, :id, :name, @production_order.warehouse_id),
                    { prompt: "Seleccionar almacén" },
                    { class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" } %>
              </div>

              <div>
                <%= form.label :product_id, "Producto", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.select :product_id,
                    options_from_collection_for_select(Product.all, :id, :name, @production_order.product_id),
                    { prompt: "Seleccionar producto" },
                    { class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" } %>
              </div>

              <div>
                <%= form.label :company_id, "Compañia", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <p class="w-full bg-gray-100 border-gray-300 text-gray-900 sm:text-sm rounded-lg p-2.5">
                  <%= current_admin.company&.name || "No asignada" %>
                </p>
                <%= form.hidden_field :company_id, value: current_admin.company&.id %>
              </div>

              <div>
                <%= form.label :quantity_requested, "Cantidad Solicitada", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.number_field :quantity_requested, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    min: 1, step: 1 %>
              </div>

              <div>
                <%= form.label :priority, "Prioridad", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.select :priority, 
                    options_for_select(ProductionOrder::PRIORITIES.map { |p| [p.humanize, p] }, @production_order.priority),
                    {},
                    { class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" } %>
              </div>

              <div class="md:col-span-2">
                <%= form.label :estimated_completion, "Fecha Estimada de Finalización", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.datetime_local_field :estimated_completion, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Printing Information Card -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Información de Impresión</h3>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
              
              <div>
                <%= form.label :bag_size, "Bolsa", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.text_field :bag_size, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    placeholder: "Ej: 50x70" %>
              </div>

              <div>
                <%= form.label :bag_measurement, "Medida bolsa", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.text_field :bag_measurement, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    placeholder: "Ej: cm" %>
              </div>

              <div>
                <%= form.label :pieces_count, "Número de piezas", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.number_field :pieces_count, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    min: 0, step: 1 %>
              </div>

              <div>
                <%= form.label :package_count, "Cantidad de paquetes", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.number_field :package_count, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    min: 0, step: 1 %>
              </div>

              <div class="md:col-span-2">
                <%= form.label :package_measurement, "Medida de paquetes", class: "block text-sm font-medium text-gray-600 mb-1" %>
                <%= form.text_field :package_measurement, 
                    class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                    placeholder: "Ej: 10 paquetes de 100 piezas" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes Card -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Notas Adicionales</h3>
            <div>
              <%= form.label :notes, "Notas", class: "block text-sm font-medium text-gray-600 mb-1 sr-only" %>
              <%= form.text_area :notes, rows: 4,
                  class: "w-full bg-gray-200 border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5",
                  placeholder: "Añadir instrucciones especiales o notas..." %>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
          <%= link_to "Cancelar", admin_production_orders_path, 
              class: "inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
          <%= form.submit "Crear Orden de Producción", 
              class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Fallback script for production order form submission (works even if Stimulus fails)
  document.addEventListener('DOMContentLoaded', function() {
    const formContainer = document.querySelector('[data-controller="production-order-form"]')
    
    if (formContainer) {
      const form = formContainer.querySelector('form')
      if (form && !form.hasAttribute('data-fallback-added')) {
        form.setAttribute('data-fallback-added', 'true')
        
        form.addEventListener('submit', function(event) {
          event.preventDefault()
          
          const submitButton = form.querySelector('input[type="submit"]')
          const originalText = submitButton.value
          submitButton.value = 'Creando...'
          submitButton.disabled = true
          
          const formData = new FormData(form)
          
          fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
              'Accept': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              
              // Store toast data in sessionStorage to show after redirect
              sessionStorage.setItem('showToast', JSON.stringify({
                type: 'success',
                title: '¡Orden creada!',
                message: data.message
              }))
              
              // Update notification counter immediately
              updateNotificationCounter()
              
              window.location.href = `/admin/production_orders/${data.production_order.id}`
            } else {
              console.error('❌ Error creating production order:', data)
              submitButton.value = originalText
              submitButton.disabled = false
            }
          })
          .catch(error => {
            console.error('❌ Fetch error:', error)
            submitButton.value = originalText
            submitButton.disabled = false
          })
        })
      }
    }
    
    // Helper function for updating notification counter
    function updateNotificationCounter() {
      const countElement = document.querySelector('.notification-count')
      if (countElement) {
        const currentCount = parseInt(countElement.textContent.replace('+', '')) || 0
        const newCount = currentCount + 1
        countElement.textContent = newCount > 99 ? "99+" : newCount.toString()
        
        // Make sure the indicator is visible
        countElement.style.display = 'flex'
      } else {
        // Create new count element if it doesn't exist
        const indicatorContainer = document.querySelector('.indicator')
        if (indicatorContainer) {
          const countSpan = document.createElement('span')
          countSpan.className = 'notification-count indicator-item badge bg-red-500 text-white text-xs font-medium border-0 min-w-[20px] h-5 flex items-center justify-center'
          countSpan.textContent = '1'
          indicatorContainer.insertBefore(countSpan, indicatorContainer.firstChild)
        }
      }
    }
  })
</script>