<% if notice.present? %>
  <%= render "shared/succes_alert", notice: notice %>
<% end %>

<!-- Flashes container -->
<div id="flashes" class="fixed top-4 right-4 z-[10000] space-y-2"></div>

<div class="w-full px-1 mt-12 mb-16 min-h-screen flex flex-col" data-responsive-right-margin="true">
  <div class="relative flex flex-col w-full px-6 text-gray-700 bg-white shadow-md lg:px-10 rounded-xl bg-clip-border flex-1">
    <div class="mt-8 relative p-4 text-gray-700 bg-white bg-clip-border flex flex-col flex-grow"
         data-controller="production-order" 
         data-order-id="<%= @production_order.id %>">
      
      <!-- Header -->
      <div class="relative flex flex-col gap-3 mb-8 lg:flex-row lg:items-start lg:justify-between">
        <div class="flex-1">
          <h1 class="text-2xl font-bold text-gray-900 mb-1">
            <%= @production_order.no_opro.present? ? "Orden No. #{@production_order.no_opro}" : "Orden ##{@production_order.order_number}" %>
          </h1>
          <p class="text-base text-gray-600">
            CVE_PROD: <span class="font-semibold"><%= @production_order.clave_producto %></span>
          </p>
          <p class="text-sm text-gray-500">
            <%= @production_order.fecha_completa&.strftime("%d/%m/%Y") || @production_order.created_at.strftime("%d/%m/%Y a las %H:%M") %>
          </p>
        </div>
        
        <div class="flex gap-2 shrink-0">
          <%= link_to admin_production_orders_path, class: "btn btn-secondary btn-sm btn-icon" do %>
            <%= icon('fa-solid', 'arrow-left', class: 'w-3 h-3') %>
            <span class="hidden sm:inline">Volver</span>
          <% end %>
          
          <%= link_to edit_admin_production_order_path(@production_order), class: "btn btn-primary btn-sm btn-icon" do %>
            <%= icon('fa-solid', 'edit', class: 'w-3 h-3') %>
            <span class="hidden sm:inline">Editar</span>
          <% end %>
          
          <% if current_admin.present? %>
            <%= button_to admin_production_order_path(@production_order), 
                method: :delete, 
                class: "btn btn-danger btn-sm btn-icon",
                data: { confirm: "¿Estás seguro de que deseas eliminar esta orden de producción?" } do %>
              <%= icon('fa-solid', 'trash', class: 'w-3 h-3') %>
              <span class="hidden sm:inline">Eliminar</span>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Consecutivos/Folios Section -->
      <div class="mb-6" data-controller="consecutivo-selection">
        <div class="border shadow-md sm:rounded-lg p-6" style="background-color: var(--color-blue-gem-50);">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
            <h3 class="text-lg font-semibold text-gray-800">Consecutivos / Folios</h3>
            <div class="flex flex-wrap items-center gap-2">
              <button id="print-labels-btn" class="btn btn-primary btn-sm btn-icon" type="button" disabled data-action="click->consecutivo-selection#showPrintConfirmation">
                <%= icon('fa-solid', 'print', class: 'w-4 h-4') %>
                Imprimir Etiqueta
              </button>
              <% if @production_order.production_order_items.any? %>
                <%= link_to print_consecutivos_admin_production_order_path(@production_order, format: :pdf), method: :get, class: "btn btn-accent btn-sm btn-icon" do %>
                  <%= icon('fa-solid', 'file-pdf', class: 'w-4 h-4') %>
                  Descargar PDF
                <% end %>
              <% end %>
              <button data-dialog-target="consecutivo-modal" class="btn btn-secondary btn-sm btn-icon" type="button">
                <%= icon('fa-solid', 'plus', class: 'w-4 h-4') %>
                Agregar
              </button>
              
              <!-- Hidden form for printing labels -->
              <%= form_with url: mark_as_printed_admin_production_order_production_order_items_path(@production_order), method: :patch, id: "print-labels-form", local: true, style: "display: none;" do |form| %>
                <div id="print-item-ids-container"></div>
              <% end %>
            </div>
          </div>
          
          <div id="consecutivos-section">
            <%= render(ConsecutivosTableComponent.new(production_order: @production_order)) %>
          </div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
        
        <!-- Production Details -->
        <div class="bg-white border shadow-md sm:rounded-lg p-6 flex flex-col">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalles de Producción</h3>
          <div class="space-y-3 text-sm flex-grow">
            <div class="flex justify-between"><span class="text-gray-500">Almacén:</span><span class="font-medium"><%= @production_order.warehouse.name %></span></div>
            <div class="flex justify-between"><span class="text-gray-500">Lote:</span><span class="font-medium"><%= @production_order.lote_referencia || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-gray-500">Cantidad:</span><span class="font-semibold"><%= @production_order.quantity_requested %></span></div>
            <div class="flex justify-between"><span class="text-gray-500">Carga:</span><span class="font-medium"><%= @production_order.carga_copr&.to_f || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-gray-500">Año:</span><span class="font-medium"><%= @production_order.ano || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-gray-500">Mes:</span><span class="font-medium"><%= @production_order.mes || 'N/A' %></span></div>
            
            <% if @production_order.notes.present? %>
              <div class="pt-3">
                <h4 class="text-sm font-medium text-gray-800 mb-1">Notas</h4>
                <div class="p-3 rounded-md" style="background-color: var(--color-bamboo-50);">
                  <p class="text-sm text-bamboo-800 whitespace-pre-wrap"><%= @production_order.notes %></p>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Timeline -->
        <div class="border shadow-md sm:rounded-lg p-6 flex flex-col" style="background-color: var(--color-bamboo-50);">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Cronología</h3>
          <div class="space-y-4 text-sm flex-grow">
            <div class="flex justify-between"><span class="text-gray-500">Creación:</span><span class="font-medium"><%= @production_order.created_at.strftime("%d/%m/%Y %H:%M") %></span></div>
            <% if @production_order.start_date.present? %>
              <div class="flex justify-between"><span class="text-gray-500">Inicio:</span><span class="font-medium"><%= @production_order.start_date.strftime("%d/%m/%Y %H:%M") %></span></div>
            <% end %>
            <% if @production_order.estimated_completion.present? %>
              <div class="flex justify-between">
                <span class="text-gray-500">Est. Finalización:</span>
                <span class="font-medium <%= 'text-mexican-red-600' if @production_order.is_overdue? %>">
                  <%= @production_order.estimated_completion.strftime("%d/%m/%Y %H:%M") %>
                  <% if @production_order.is_overdue? %>
                    <span>(Atrasado)</span>
                  <% end %>
                </span>
              </div>
            <% end %>
            <% if @production_order.actual_completion.present? %>
              <div class="flex justify-between"><span class="text-gray-500">Finalización:</span><span class="font-medium"><%= @production_order.actual_completion.strftime("%d/%m/%Y %H:%M") %></span></div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Consecutivo Modal -->
<%= render(ConsecutivoModalComponent.new(production_order: @production_order)) %>

<!-- Edit Consecutivo Modal -->
<%= render(EditConsecutivoModalComponent.new) %>
>
