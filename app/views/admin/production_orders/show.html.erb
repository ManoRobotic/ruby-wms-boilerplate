<% if notice.present? %>
  <%= render "shared/succes_alert", notice: notice %>
<% end %>

<div class="w-full px-1 mt-12 mb-16 min-h-screen flex flex-col" data-responsive-right-margin="true">
  <div class="relative flex flex-col w-full px-6 text-gray-700 bg-white shadow-md lg:px-10 rounded-xl bg-clip-border flex-1">
    <div class=" mt-8 relative p-4 text-gray-700 bg-white bg-clip-border flex flex-col flex-grow"
         data-controller="production-order" 
         data-order-id="<%= @production_order.id %>">
      <div class="flex flex-col flex-grow">
      
      <!-- Header -->
      <div class="relative flex flex-col gap-3 mb-4 lg:flex-row lg:items-start lg:justify-between">
        <div class="flex-1">
          <h1 class="text-lg font-semibold text-gray-900 mb-1">
            <%= @production_order.no_opro.present? ? "Orden No. #{@production_order.no_opro}" : "Orden ##{@production_order.order_number}" %>
          </h1>
          <p class="text-sm text-gray-600">
            Producto: <%= @production_order.product.name %>
          </p>
          <p class="text-xs text-gray-500">
            <%= @production_order.fecha_completa&.strftime("%d/%m/%Y") || @production_order.created_at.strftime("%d/%m/%Y a las %H:%M") %>
          </p>
        </div>
        
        <div class="flex gap-2 shrink-0 lg:absolute lg:top-0 lg:right-0 lg:z-10">
          <%= link_to admin_production_orders_path, 
              class: "px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-1" do %>
            <%= icon('fa-solid', 'arrow-left', class: 'w-3 h-3') %>
            Volver
          <% end %>
          
          <%= link_to edit_admin_production_order_path(@production_order), 
              class: "px-3 py-1.5 text-xs font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 flex items-center gap-1" do %>
            <%= icon('fa-solid', 'edit', class: 'w-3 h-3') %>
            Editar
          <% end %>
        </div>
      </div>

      <!-- Status and Progress -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
        <!-- Status -->
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">Estado:</span>
          <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
            <%= case @production_order.status
                when 'pending' then 'bg-yellow-100 text-yellow-800'
                when 'scheduled' then 'bg-blue-100 text-blue-800'
                when 'in_progress' then 'bg-green-100 text-green-800'
                when 'paused' then 'bg-orange-100 text-orange-800'
                when 'completed' then 'bg-gray-100 text-gray-800'
                when 'cancelled' then 'bg-red-100 text-red-800'
                end %>">
            <%= @production_order.status.humanize %>
          </span>
        </div>
        
        <!-- Priority -->
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-500">Prioridad:</span>
          <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
            <%= case @production_order.priority
                when 'low' then 'bg-gray-100 text-gray-800'
                when 'medium' then 'bg-blue-100 text-blue-800'
                when 'high' then 'bg-orange-100 text-orange-800'
                when 'urgent' then 'bg-red-100 text-red-800'
                end %>">
            <%= @production_order.priority.humanize %>
          </span>
        </div>

       
      </div>

      <!-- Consecutivos/Folios Section -->
      <div class="mb-6" data-controller="consecutivo-selection">
        <div class="bg-emerald-50 rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow duration-300">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
            <h3 class="text-base font-semibold text-emerald-900">Consecutivos / Folios</h3>
            <div class="flex flex-wrap items-center gap-2">
              <button 
                id="print-labels-btn"
                class="rounded-md bg-purple-600 py-2 px-4 border border-transparent text-center text-sm font-semibold text-white transition-all shadow-md hover:shadow-lg focus:bg-purple-700 focus:shadow-none active:bg-purple-700 hover:bg-purple-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none flex items-center gap-2"
                type="button"
                disabled
                data-action="click->consecutivo-selection#printLabels">
                <%= icon('fa-solid', 'print', class: 'w-4 h-4') %>
                Imprimir Etiqueta
              </button>
              <% if @production_order.production_order_items.any? %>
                <%= link_to print_consecutivos_admin_production_order_path(@production_order, format: :pdf), 
                    method: :get,
                    class: "rounded-md bg-purple-600 py-2 px-4 border border-transparent text-center text-sm font-semibold text-white transition-all shadow-md hover:shadow-lg focus:bg-purple-700 focus:shadow-none active:bg-purple-700 hover:bg-purple-700 active:shadow-none flex items-center gap-2" do %>
                  <%= icon('fa-solid', 'file-pdf', class: 'w-4 h-4') %>
                  Descargar PDF Packing
                <% end %>
              <% end %>
              <button 
                data-dialog-target="consecutivo-modal"
                class="rounded-md bg-emerald-600 py-2 px-4 border border-transparent text-center text-sm font-semibold text-white transition-all shadow-md hover:shadow-lg focus:bg-emerald-700 focus:shadow-none active:bg-emerald-700 hover:bg-emerald-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none flex items-center gap-2" 
                type="button">
                <%= icon('fa-solid', 'plus', class: 'w-4 h-4') %>
                Agregar
              </button>
            </div>
          </div>
          
          <% if @production_order.production_order_items.any? %>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-emerald-200">
                <thead class="bg-emerald-100">
                  <tr>
                    <th class="px-2 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">
                      <div class="inline-flex items-center">
                        <label class="flex items-center cursor-pointer relative">
                          <input type="checkbox" 
                                 id="select-all-consecutivos"
                                 class="peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-emerald-300 checked:bg-emerald-800 checked:border-emerald-800" 
                                 data-action="change->consecutivo-selection#toggleAll"
                                 data-consecutivo-selection-target="selectAll" />
                          <span class="absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" stroke="currentColor" stroke-width="1">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                          </span>
                        </label>
                      </div>
                    </th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider">Folio</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Peso Bruto (kg)</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Peso Neto (kg)</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Metros</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Micras</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Ancho (mm)</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Estado</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-emerald-800 uppercase tracking-wider">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-emerald-100">
                  <% @production_order.production_order_items.order(:folio_consecutivo).each do |item| %>
                    <tr class="hover:bg-emerald-25">
                      <td class="px-2 py-2 text-center text-sm font-medium">
                        <div class="inline-flex items-center">
                          <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" 
                                   class="consecutivo-checkbox peer h-4 w-4 cursor-pointer transition-all appearance-none rounded shadow hover:shadow-md border border-emerald-300 checked:bg-emerald-800 checked:border-emerald-800" 
                                   data-consecutivo-id="<%= item.id %>" 
                                   data-action="change->consecutivo-selection#updateSelection" 
                                   data-consecutivo-selection-target="consecutivoCheckbox"
                                   data-folio="<%= item.folio_consecutivo %>"
                                   data-lote="<%= @production_order.lote_referencia %>"
                                   data-clave-producto="<%= @production_order.clave_producto || 'BOPPTRANS 35 / 420' %>"
                                   data-peso-bruto="<%= item.peso_bruto %>"
                                   data-peso-neto="<%= item.peso_neto %>"
                                   data-metros-lineales="<%= item.metros_lineales %>"
                                   data-no-opro="<%= @production_order.no_opro || @production_order.order_number %>" />
                            <span class="absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor" stroke="currentColor" stroke-width="1">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                              </svg>
                            </span>
                          </label>
                        </div>
                      </td>
                      <td class="px-3 py-2 text-sm font-medium text-gray-900">
                        <%= item.folio_consecutivo %>
                      </td>
                      <td class="px-3 py-2 text-sm text-center text-gray-500">
                        <%= item.peso_bruto&.round(2) || '-' %>
                      </td>
                      <td class="px-3 py-2 text-sm text-center text-gray-500">
                        <%= item.peso_neto&.round(2) || '-' %>
                      </td>
                      <td class="px-3 py-2 text-sm text-center text-gray-500">
                        <%= item.metros_lineales&.round(1) || '-' %>
                      </td>
                      <td class="px-3 py-2 text-sm text-center text-gray-500">
                        <%= item.micras || '-' %>
                      </td>
                      <td class="px-3 py-2 text-sm text-center text-gray-500">
                        <%= item.ancho_mm || '-' %>
                      </td>
                      <td class="px-3 py-2 text-center">
                        <% if item.status.present? %>
                          <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                            <%= case item.status
                                when 'pending' then 'bg-yellow-100 text-yellow-800'
                                when 'in_production' then 'bg-blue-100 text-blue-800'
                                when 'completed' then 'bg-green-100 text-green-800'
                                when 'cancelled' then 'bg-red-100 text-red-800'
                                end %>">
                            <%= item.status.humanize %>
                          </span>
                        <% else %>
                          <span class="text-gray-400">-</span>
                        <% end %>
                      </td>
                      <td class="px-3 py-2 text-center text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-2 px-2 py-1 text-xs rounded-md hover:bg-blue-50 transition-colors duration-200" data-action="click->consecutivo-selection#pesarItem" data-item-id="<%= item.id %>">
                          Pesar
                        </button>
                        <%= link_to 'Editar', edit_admin_production_order_production_order_item_path(@production_order, item), 
                            class: "text-emerald-600 hover:text-emerald-900 mr-2 px-2 py-1 text-xs rounded-md hover:bg-emerald-50 transition-colors duration-200" %>
                        <%= link_to 'Eliminar', admin_production_order_production_order_item_path(@production_order, item), 
                            method: :delete,
                            class: "text-red-600 hover:text-red-900 px-2 py-1 text-xs rounded-md hover:bg-red-50 transition-colors duration-200",
                            confirm: "¿Estás seguro de que quieres eliminar este consecutivo?" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <!-- Resumen de consecutivos -->
            
            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white rounded-lg p-3 border border-emerald-200">
                <div class="text-xs text-emerald-600">Total Consecutivos</div>
                <div class="text-lg font-semibold text-emerald-900">
                  <%= @production_order.production_order_items.count %>
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-emerald-200">
                <div class="text-xs text-emerald-600">Peso Bruto Total</div>
                <div class="text-lg font-semibold text-emerald-900">
                  <%= @production_order.production_order_items.sum { |item| item.peso_bruto || 0 }.round(2) %> kg
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-emerald-200">
                <div class="text-xs text-emerald-600">Peso Neto Total</div>
                <div class="text-lg font-semibold text-emerald-900">
                  <%= @production_order.production_order_items.sum { |item| item.peso_neto || 0 }.round(2) %> kg
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-emerald-200">
                <div class="text-xs text-emerald-600">Metros Totales</div>
                <div class="text-lg font-semibold text-emerald-900">
                  <%= @production_order.production_order_items.sum { |item| item.metros_lineales || 0 }.round(1) %> m
                </div>
              </div>
            </div>
          <% else %>
            <div class="text-center py-8">
              <div class="text-emerald-400 mb-2">
                <%= icon('fa-solid', 'file-alt', class: 'w-12 h-12 mx-auto') %>
              </div>
              <h3 class="text-sm font-medium text-emerald-900 mb-1">No hay consecutivos</h3>
              <p class="text-sm text-emerald-600">Crea el primer consecutivo para esta orden de producción</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
        
        <!-- Production Details -->
        <div class="bg-slate-50 rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow duration-300 flex flex-col">
          <h3 class="text-base font-semibold text-slate-900 mb-4">Detalles de Producción</h3>
          
          <div class="space-y-3 text-sm flex-grow">
            <div class="flex justify-between">
              <span class="text-slate-500">Almacén:</span>
              <span class="text-slate-900 font-medium"><%= @production_order.warehouse.name %></span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-slate-500">Lote:</span>
              <span class="text-slate-900 font-medium"><%= @production_order.lote_referencia || 'N/A' %></span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-slate-500">Cantidad:</span>
              <span class="text-slate-900 font-semibold"><%= @production_order.quantity_requested %></span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-slate-500">Carga:</span>
              <span class="text-slate-900 font-medium"><%= @production_order.carga_copr&.to_f || 'N/A' %></span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-slate-500">Año:</span>
              <span class="text-slate-900 font-medium"><%= @production_order.ano || 'N/A' %></span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-slate-500">Mes:</span>
              <span class="text-slate-900 font-medium"><%= @production_order.mes || 'N/A' %></span>
            </div>
            


               <!-- Notes Section -->
      <% if @production_order.notes.present? %>
        <div class=" flex flex-col gap-4 mt-4">
          <div class="bg-amber-50 rounded-lg p-3">
            <h3 class="text-sm font-medium text-gray-900 mb-2">Notas</h3>
            <p class="text-xs text-gray-700 whitespace-pre-wrap"><%= @production_order.notes %></p>
          </div>
        </div>
      <% end %>
            
            <!-- Separator -->
            <div class="border-t border-slate-200 pt-3 mt-3">
              <ul class="space-y-1 text-xs text-slate-700">
                <li>• No. OPRO: <%= @production_order.no_opro || @production_order.order_number %></li>
                <li>• Producto: <%= @production_order.product.name %></li>
                <li>• Cantidad: <%= @production_order.quantity_requested %></li>
                <li>• Lote: <%= @production_order.lote_referencia || 'N/A' %></li>
                <% if @production_order.peso.present? %>
                  <li>• Peso: <%= @production_order.peso %> kg</li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <div class="bg-amber-50 rounded-xl p-6 shadow-sm hover:shadow-lg transition-shadow duration-300 flex flex-col">
          <h3 class="text-base font-semibold text-amber-900 mb-4">Cronología</h3>
          
          <div class="space-y-3 text-sm flex-grow">
            <div>
              <span class="text-amber-600">Creación:</span>
              <span class="text-amber-900 font-medium block"><%= @production_order.created_at.strftime("%d/%m/%Y %H:%M") %></span>
            </div>
            
            <% if @production_order.start_date.present? %>
              <div>
                <span class="text-amber-600">Inicio:</span>
                <span class="text-amber-900 font-medium block"><%= @production_order.start_date.strftime("%d/%m/%Y %H:%M") %></span>
              </div>
            <% end %>
            
            <% if @production_order.estimated_completion.present? %>
              <div>
                <span class="text-amber-600">Est. Finalización:</span>
                <span class="text-amber-900 font-medium block <%= 'text-red-600' if @production_order.is_overdue? %>">
                  <%= @production_order.estimated_completion.strftime("%d/%m/%Y %H:%M") %>
                  <% if @production_order.is_overdue? %>
                    <span class="text-red-600">(Atrasado)</span>
                  <% end %>
                </span>
              </div>
            <% end %>
            
            <% if @production_order.actual_completion.present? %>
              <div>
                <span class="text-amber-600">Finalización:</span>
                <span class="text-amber-900 font-medium block"><%= @production_order.actual_completion.strftime("%d/%m/%Y %H:%M") %></span>
              </div>
            <% end %>
          </div>
        </div>

      </div>


   
      
      </div>
    </div>
  </div>
</div>

<style>
@media (min-width: 768px) {
  [data-responsive-right-margin="true"] {
    max-width: calc(100% - 0.75rem) !important;
  }
}
@media (max-width: 767px) {
  [data-responsive-right-margin="true"] {
    max-width: 100% !important;
  }
}
</style>

<!-- Consecutivo Modal -->
<div
  data-controller="dialog"
  data-dialog-backdrop="consecutivo-modal"
  data-dialog-backdrop-close="true"
  class="pointer-events-none fixed inset-0 z-[9999] grid h-screen w-screen place-items-center bg-transparent opacity-0 backdrop-blur-sm transition-opacity duration-300"
>
  <div
    data-dialog="consecutivo-modal"
    class="relative m-4 p-4 w-11/12 max-w-2xl rounded-lg bg-white shadow-2xl max-h-[80vh] overflow-y-auto border border-gray-300"
  >
    <!-- Modal header -->
    <div class="flex shrink-0 items-center pb-2 text-base font-medium text-slate-800 border-b border-slate-200">
      Crear Nuevo Folio
    </div>
            
            <!-- Modal body -->
            <% new_item = @production_order.production_order_items.build %>
            <%= form_with model: [ :admin, @production_order, new_item ], 
                local: true, 
                data: { controller: "consecutivo-form", action: "submit->consecutivo-form#handleFormSubmit" },
                class: "relative border-t border-slate-200 py-2" do |form| %>
                
                <div class="grid gap-2 mb-2">
                    <!-- Folio Consecutivo (Auto-generated, readonly) -->
                    <div>
                        <label class="block mb-1 text-sm font-medium text-slate-700">Folio Consecutivo</label>
                        <div class="flex items-center gap-2">
                            <%= form.text_field :folio_consecutivo, 
                                class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg block w-full p-2",
                                value: ProductionOrderItem.generate_folio_consecutivo(@production_order),
                                placeholder: "Se genera automáticamente" %>
                        </div>
                    </div>

                    <!-- Product Name (Pre-filled with clave_producto) -->
                    <div>
                        <label for="clave_producto" class="block mb-1 text-sm font-medium text-slate-700">Clave Producto</label>
                        <%= form.text_field :clave_producto_display, 
                            name: "clave_producto_display",
                            id: "clave_producto", 
                            class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                            value: @production_order.clave_producto || "BOPPTRANS 35 / 420",
                            placeholder: "BOPPTRANS 35 / 420",
                            readonly: true %>
                    </div>

                    <!-- Control de modo de pesaje -->
                    <div class="mb-3">
                        <!-- Mensajes de modo -->
                        <div data-consecutivo-form-target="scaleWeightSection">
                            <!-- Mensaje cuando está en modo báscula (por defecto) -->
                            <p class="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-md p-2 scale-mode-message">
                                <span class="font-medium">Modo Báscula Activo:</span> Use el control de pesaje abajo para obtener el peso automáticamente.
                            </p>
                            
                            <!-- Mensaje cuando está en modo manual (oculto por defecto) -->
                            <p class="text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded-md p-2 manual-mode-message hidden">
                                <span class="font-medium">Modo de Uso:</span> Ingreso manual, ingrese peso del folio manualmente.
                            </p>
                        </div>
                        
                        <!-- Checkbox moved here -->
                        <div class="flex items-center mt-1">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                       data-action="change->consecutivo-form#toggleManualMode"
                                       data-consecutivo-form-target="manualModeCheckbox">
                                <span class="ml-2 text-sm font-medium text-gray-700">Ingresar peso manualmente</span>
                            </label>
                        </div>

                        <!-- Input de peso manual (deshabilitado por defecto) -->
                        <div data-consecutivo-form-target="manualWeightSection" class="hidden">
                            <label class="block mb-1 text-sm font-medium text-slate-700 mt-4">Peso Bruto (kg)</label>
                            <div class="flex items-center">
                                <%= form.number_field :peso_bruto, 
                                    class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                                    placeholder: "0.00",
                                    step: 0.01,
                                    min: 0,
                                    disabled: true,
                                    data: { 
                                      action: "input->consecutivo-form#calculateWeights",
                                      "consecutivo-form-target": "pesoBrutoInput"
                                    } %>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">Ingrese el peso manualmente</p>
                        </div>
                    </div>

                    <!-- Componente de Pesaje -->
                    <div class="bg-gray-50 rounded-md p-2 mb-2 transition-opacity duration-300" 
                         data-controller="serial" 
                         data-serial-base-url-value="/api/serial"
                         data-serial-auto-connect-value="false"
                         data-consecutivo-form-target="serialSection">
                      <h4 class="font-medium text-gray-700 mb-1.5 text-sm">Control de Pesaje</h4>
                      
                      <!-- Status de Conexión -->
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-sm font-medium text-gray-600">Estado:</span>
                        <span data-serial-target="status" class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Desconectado</span>
                      </div>

                      <!-- Weight Display -->
                      <div class="weight-section p-2 bg-white rounded-md border mb-2">
                        <div class="flex items-center justify-between mb-1.5">
                          <span class="font-medium text-gray-700 text-sm">Peso actual:</span>
                          <div class="flex gap-1">
                            <button data-action="click->serial#connectScale" 
                                    type="button"
                                    class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-all duration-200">
                              Conectar
                            </button>
                            <button data-action="click->serial#readWeightNow" 
                                    type="button"
                                    class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-all duration-200">
                              Leer ahora
                            </button>
                          </div>
                        </div>
                        <div data-serial-target="weight" class="weight-display">
                          <div class="text-2xl font-bold block text-center transition-all duration-300 ease-in-out text-gray-400">--</div>
                          <div class="text-sm text-gray-500 block text-center">--</div>
                        </div>
                        
                        <!-- Botón para usar peso en el formulario -->
                        <button type="button" 
                                data-action="click->consecutivo-form#useSerialWeight"
                                class="w-full mt-1.5 px-2 py-1 bg-emerald-600 text-white text-sm rounded-md hover:bg-emerald-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                          Usar este peso
                        </button>
                      </div>
                    </div>

                    <!-- Campos calculados automáticamente -->
                    <div class="bg-emerald-50 rounded-md p-2 mb-2">
                        <h4 class="text-sm font-semibold text-emerald-900 mb-1.5">Cálculos Automáticos</h4>
                        
                        <div class="grid grid-cols-2 gap-1.5">
                            <!-- Peso Neto -->
                            <div class="bg-white rounded p-1.5 border border-emerald-200">
                                <div class="text-xs text-emerald-600 font-medium">Peso Neto</div>
                                <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="pesoNetoDisplay">0.000 kg</div>
                                <%= form.hidden_field :peso_neto, data: { "consecutivo-form-target": "pesoNeto" } %>
                            </div>

                            <!-- Peso Core -->
                            <div class="bg-white rounded p-1.5 border border-emerald-200">
                                <div class="text-xs text-emerald-600 font-medium">Peso Core</div>
                                <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="pesoCoreDisplay">200 g</div>
                            </div>

                            <!-- Metros Lineales -->
                            <div class="bg-white rounded p-1.5 border border-emerald-200">
                                <div class="text-xs text-emerald-600 font-medium">Metros Lineales</div>
                                <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="metrosLinealesDisplay">0.0000 m</div>
                                <%= form.hidden_field :metros_lineales, data: { "consecutivo-form-target": "metrosLineales" } %>
                            </div>

                            <!-- Especificaciones -->
                            <div class="bg-white rounded p-1.5 border border-emerald-200">
                                <div class="text-xs text-emerald-600 font-medium">Especificaciones</div>
                                <div class="text-xs font-semibold text-emerald-900" data-consecutivo-form-target="especificacionesDisplay">35μ / 420mm</div>
                                <%= form.hidden_field :micras %>
                                <%= form.hidden_field :ancho_mm %>
                            </div>
                        </div>

                        <div class="text-xs text-emerald-700 mt-1.5 opacity-75">
                            Los cálculos se actualizan automáticamente al ingresar el peso bruto
                        </div>
                    </div>

                    
                </div>

                <!-- Hidden fields for calculated values -->
                <%= form.hidden_field :peso_core_gramos %>
                <%= form.hidden_field :altura_cm, value: 75 %>
                
                <!-- Form buttons -->
                <div class="flex shrink-0 flex-wrap items-center pt-2 justify-end border-t border-slate-200">
                  <button 
                    data-dialog-close="true" 
                    type="button"
                    class="rounded-md border border-transparent py-1 px-2.5 text-center text-sm transition-all text-slate-600 hover:bg-slate-100 focus:bg-slate-100 active:bg-slate-100 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none">
                    Cancelar
                  </button>
                  <%= form.submit "Crear Consecutivo", 
                      class: "rounded-md bg-emerald-600 py-1 px-2.5 border border-transparent text-center text-sm text-white transition-all shadow hover:shadow focus:bg-emerald-700 focus:shadow-none active:bg-emerald-700 hover:bg-emerald-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none ml-1.5" %>
                </div>
            <% end %>
  </div>
</div>

<%= render "consecutivo_modal" %>
