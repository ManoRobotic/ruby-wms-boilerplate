<% content_for(:title, "Escáner de Códigos de Barras") %>

<div class="w-full px-4 mt-8">
  <div class="relative flex flex-col w-full text-gray-700 bg-white shadow-md rounded-xl bg-clip-border">
    <div class="relative p-6 text-gray-700 bg-white bg-clip-border">
      
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Escáner de Códigos de Barras</h1>
          <p class="text-gray-600 mt-1">Escanea códigos de barras de órdenes de producción para ver los datos</p>
        </div>
        
        <%= link_to admin_production_orders_path, 
            class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
          <%= icon('fa-solid', 'arrow-left', class: 'w-4 h-4 mr-2') %>
          Volver
        <% end %>
      </div>

      <!-- Scanner Interface -->
      <div class="max-w-md mx-auto">
        <div class="mb-6">
          <label for="barcode_input" class="block text-sm font-medium text-gray-700 mb-2">
            Datos del código de barras (JSON)
          </label>
          <textarea id="barcode_input" 
                    rows="4"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder='{"id":"uuid","order_number":"PO202501001","format":"bag","bolsa":"Tipo A","medida_bolsa":"10x15","numero_piezas":"100","product":"Producto X","created_at":"2025-01-01T12:00:00Z"}'></textarea>
        </div>

        <button id="scan_button" 
                class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Procesar Código de Barras
        </button>
      </div>

      <!-- Results -->
      <div id="results" class="mt-8 hidden">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Información del Código de Barras</h3>
        <div id="results_content" class="bg-gray-50 rounded-lg p-4">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>

      <!-- Error Display -->
      <div id="error" class="mt-6 hidden">
        <div class="bg-red-50 border border-red-300 rounded-lg p-4">
          <div class="flex">
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <div class="mt-2 text-sm text-red-700">
                <p id="error_message"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('scan_button').addEventListener('click', function() {
  const barcodeData = document.getElementById('barcode_input').value;
  const resultsDiv = document.getElementById('results');
  const errorDiv = document.getElementById('error');
  
  // Hide previous results
  resultsDiv.classList.add('hidden');
  errorDiv.classList.add('hidden');
  
  if (!barcodeData.trim()) {
    showError('Por favor ingresa los datos del código de barras');
    return;
  }
  
  // Make API call
  fetch('<%= admin_production_orders_scan_barcode_path %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({
      barcode_data: barcodeData
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showResults(data);
    } else {
      showError(data.error || 'Error desconocido');
    }
  })
  .catch(error => {
    showError('Error de conexión: ' + error.message);
  });
});

function showResults(data) {
  const resultsDiv = document.getElementById('results');
  const contentDiv = document.getElementById('results_content');
  
  let html = `
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div>
        <h4 class="font-semibold text-gray-900 mb-2">Orden de Producción</h4>
        <dl class="space-y-1">
          <div>
            <dt class="text-sm font-medium text-gray-500">Número de Orden:</dt>
            <dd class="text-sm text-gray-900">${data.production_order.order_number}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Producto:</dt>
            <dd class="text-sm text-gray-900">${data.production_order.product}</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Fecha de Creación:</dt>
            <dd class="text-sm text-gray-900">${new Date(data.production_order.created_at).toLocaleString()}</dd>
          </div>
        </dl>
      </div>
      
      <div>
        <h4 class="font-semibold text-gray-900 mb-2">${data.format_data.format}</h4>
        <dl class="space-y-1">
  `;
  
  if (data.format_data.bolsa) {
    html += `
      <div>
        <dt class="text-sm font-medium text-gray-500">Bolsa:</dt>
        <dd class="text-sm text-gray-900">${data.format_data.bolsa}</dd>
      </div>
    `;
  }
  
  if (data.format_data.medida_bolsa) {
    html += `
      <div>
        <dt class="text-sm font-medium text-gray-500">Medida bolsa:</dt>
        <dd class="text-sm text-gray-900">${data.format_data.medida_bolsa}</dd>
      </div>
    `;
  }
  
  if (data.format_data.numero_piezas) {
    html += `
      <div>
        <dt class="text-sm font-medium text-gray-500">Número de piezas:</dt>
        <dd class="text-sm text-gray-900">${data.format_data.numero_piezas}</dd>
      </div>
    `;
  }
  
  if (data.format_data.cantidad_paquetes) {
    html += `
      <div>
        <dt class="text-sm font-medium text-gray-500">Cantidad de paquetes:</dt>
        <dd class="text-sm text-gray-900">${data.format_data.cantidad_paquetes}</dd>
      </div>
    `;
  }
  
  if (data.format_data.medida_paquetes) {
    html += `
      <div>
        <dt class="text-sm font-medium text-gray-500">Medida de paquetes:</dt>
        <dd class="text-sm text-gray-900">${data.format_data.medida_paquetes}</dd>
      </div>
    `;
  }
  
  html += `
        </dl>
      </div>
    </div>
  `;
  
  contentDiv.innerHTML = html;
  resultsDiv.classList.remove('hidden');
}

function showError(message) {
  const errorDiv = document.getElementById('error');
  const errorMessage = document.getElementById('error_message');
  
  errorMessage.textContent = message;
  errorDiv.classList.remove('hidden');
}
</script>