<%# Shared form partial for creating/editing consecutivos %>
<%= form_with model: (consecutivo_form.persisted? ? [ :admin, @production_order, consecutivo_form ] : [ :admin, @production_order, consecutivo_form ]), 
    url: (consecutivo_form.persisted? ? admin_production_order_production_order_item_path(@production_order, consecutivo_form) : admin_production_order_production_order_items_path(@production_order)),
    method: (consecutivo_form.persisted? ? :patch : :post),
    local: true, 
    data: { controller: "consecutivo-form", action: "submit->consecutivo-form#handleFormSubmit" },
    class: "relative border-t border-slate-200 py-2" do |form| %>
    
    <div class="grid gap-2 mb-2">
        <!-- Folio Consecutivo -->
        <div>
            <label class="block mb-1 text-sm font-medium text-slate-700">Folio Consecutivo</label>
            <div class="flex items-center gap-2">
                <%= form.text_field :folio_consecutivo, 
                    class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg block w-full p-2",
                    readonly: consecutivo_form.persisted? %>
            </div>
        </div>

        <!-- Product Name (Pre-filled with clave_producto) -->
        <div>
            <label for="clave_producto" class="block mb-1 text-sm font-medium text-slate-700">Clave Producto</label>
            <%= form.text_field :clave_producto_display, 
                name: "clave_producto_display",
                id: "clave_producto", 
                class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                value: @production_order.clave_producto || "BOPPTRANS 35 / 420",
                placeholder: "BOPPTRANS 35 / 420",
                readonly: true %>
        </div>

        <!-- Control de modo de pesaje -->
        <div class="mb-3">
            <!-- Mensajes de modo -->
            <div data-consecutivo-form-target="scaleWeightSection">
                <!-- Mensaje cuando está en modo báscula (por defecto) -->
                <p class="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-md p-2 scale-mode-message">
                    <span class="font-medium">Modo Báscula Activo:</span> Use el control de pesaje abajo para obtener el peso automáticamente.
                </p>
                
                <!-- Mensaje cuando está en modo manual (oculto por defecto) -->
                <p class="text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded-md p-2 manual-mode-message hidden">
                    <span class="font-medium">Modo de Uso:</span> Ingreso manual, ingrese peso del folio manualmente.
                </p>
            </div>
            
            <!-- Checkbox moved here -->
            <div class="flex items-center mt-1">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                           data-action="change->consecutivo-form#toggleManualMode"
                           data-consecutivo-form-target="manualModeCheckbox">
                    <span class="ml-2 text-sm font-medium text-gray-700">Ingresar peso manualmente</span>
                </label>
            </div>

            <!-- Input de peso manual (deshabilitado por defecto) -->
            <div data-consecutivo-form-target="manualWeightSection" class="hidden">
                <label class="block mb-1 text-sm font-medium text-slate-700 mt-4">Peso Bruto (kg)</label>
                <div class="flex items-center">
                    <%= form.number_field :peso_bruto_manual, 
                        class: "bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2",
                        placeholder: "0.00",
                        step: 0.01,
                        min: 0,
                        disabled: true,
                        data: { 
                          action: "input->consecutivo-form#calculateWeights",
                          "consecutivo-form-target": "pesoBrutoInput"
                        },
                        value: consecutivo_form.persisted? ? consecutivo_form.peso_bruto : nil %>
                </div>
                <p class="text-xs text-gray-600 mt-1">Ingrese el peso manualmente</p>
            </div>
        </div>

        <!-- Componente de Pesaje -->
        <div class="bg-gray-50 rounded-md p-2 mb-2 transition-opacity duration-300" 
             data-controller="consecutivo-scale" 
             data-consecutivo-scale-base-url-value="http://localhost:5002"
             data-consecutivo-scale-auto-connect-value="true"
             data-consecutivo-scale-saved-port-value="<%= current_admin&.company&.serial_port || '' %>"
             data-consecutivo-form-target="serialSection">
          <h4 class="font-medium text-gray-700 mb-1.5 text-sm">Control de Pesaje</h4>
          
          <!-- Puerto Serial -->
          <div class="mb-2">
            <label class="block text-xs font-medium text-gray-600 mb-1">Puerto Serial</label>
            <select data-consecutivo-scale-target="portSelect" 
                    class="w-full text-xs rounded border-gray-300 focus:border-blue-500 focus:ring-blue-500">
              <option value="">Detectando puertos...</option>
            </select>
          </div>
          
          <!-- Status de Conexión -->
          <div class="flex items-center justify-between mb-1.5">
            <span class="text-sm font-medium text-gray-600">Estado:</span>
            <span data-consecutivo-scale-target="status" class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Iniciando...</span>
          </div>

          <!-- Weight Display -->
          <div class="weight-section p-2 bg-white rounded-md border mb-2">
            <div class="flex items-center justify-between mb-1.5">
              <span class="font-medium text-gray-700 text-sm">Peso actual:</span>
              <div class="flex gap-1">
                <button data-consecutivo-scale-target="connectBtn"
                        data-action="click->consecutivo-scale#connectScale" 
                        type="button"
                        class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-all duration-200">
                  Conectar
                </button>
                <button data-consecutivo-scale-target="readBtn"
                        data-action="click->consecutivo-scale#readWeightNow" 
                        type="button"
                        class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                  Leer ahora
                </button>
              </div>
            </div>
            <div data-consecutivo-scale-target="weight" class="weight-display">
              <div class="text-xl font-bold block text-center transition-all duration-300 ease-in-out text-gray-400">--</div>
              <div class="text-xs text-gray-500 block text-center">--</div>
            </div>
          </div>
        </div>

        <!-- Campos calculados automáticamente -->
        <div class="bg-emerald-50 rounded-md p-2 mb-2">
            <h4 class="text-sm font-semibold text-emerald-900 mb-1.5">Cálculos Automáticos</h4>
            
            <div class="grid grid-cols-2 gap-1.5">
                <!-- Peso Neto -->
                <div class="bg-white rounded p-1.5 border border-emerald-200">
                    <div class="text-xs text-emerald-600 font-medium">Peso Neto</div>
                    <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="pesoNetoDisplay">
                      <%= consecutivo_form.peso_neto ? "#{consecutivo_form.peso_neto.round(3)} kg" : "0.000 kg" %>
                    </div>
                    <%= form.hidden_field :peso_neto, data: { "consecutivo-form-target": "pesoNeto" } %>
                </div>

                <!-- Peso Core -->
                <div class="bg-white rounded p-1.5 border border-emerald-200">
                    <div class="text-xs text-emerald-600 font-medium">Peso Core</div>
                    <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="pesoCoreDisplay">
                      <%= consecutivo_form.peso_core_gramos ? "#{consecutivo_form.peso_core_gramos} g" : "200 g" %>
                    </div>
                </div>

                <!-- Metros Lineales -->
                <div class="bg-white rounded p-1.5 border border-emerald-200">
                    <div class="text-xs text-emerald-600 font-medium">Metros Lineales</div>
                    <div class="text-sm font-bold text-emerald-900" data-consecutivo-form-target="metrosLinealesDisplay">
                      <%= consecutivo_form.metros_lineales ? "#{consecutivo_form.metros_lineales.round(4)} m" : "0.0000 m" %>
                    </div>
                    <%= form.hidden_field :metros_lineales, data: { "consecutivo-form-target": "metrosLineales" } %>
                </div>

                <!-- Especificaciones -->
                <div class="bg-white rounded p-1.5 border border-emerald-200">
                    <div class="text-xs text-emerald-600 font-medium">Especificaciones</div>
                    <div class="text-xs font-semibold text-emerald-900" data-consecutivo-form-target="especificacionesDisplay">
                      <%= "#{consecutivo_form.micras || 35}μ / #{consecutivo_form.ancho_mm || 420}mm" %>
                    </div>
                    <%= form.hidden_field :micras %>
                    <%= form.hidden_field :ancho_mm %>
                </div>
            </div>

            <div class="text-xs text-emerald-700 mt-1.5 opacity-75">
                Los cálculos se actualizan automáticamente al ingresar el peso bruto
            </div>
        </div>

        
    </div>

    <!-- Hidden fields for calculated values -->
    <%= form.hidden_field :peso_core_gramos %>
    <%= form.hidden_field :altura_cm, value: 75 %>
    <%= form.hidden_field :peso_bruto, data: { "consecutivo-form-target": "pesoBrutoHidden" } %>
    <%= form.hidden_field :peso_bruto_manual, data: { "consecutivo-form-target": "pesoBrutoManualHidden" } %>
    
    <!-- Form buttons -->
    <div class="flex shrink-0 flex-wrap items-center pt-2 justify-end border-t border-slate-200">
      <button 
        data-dialog-close="true" 
        type="button"
        class="rounded-md border border-transparent py-1 px-2.5 text-center text-sm transition-all text-slate-600 hover:bg-slate-100 focus:bg-slate-100 active:bg-slate-100 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none">
        Cancelar
      </button>
      <%= form.submit consecutivo_form.persisted? ? "Guardar Consecutivo" : "Crear Consecutivo", 
          class: "rounded-md bg-emerald-600 py-1 px-2.5 border border-transparent text-center text-sm text-white transition-all shadow hover:shadow focus:bg-emerald-700 focus:shadow-none active:bg-emerald-700 hover:bg-emerald-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none ml-1.5",
          data: { "form-validation-target": "submit" } %>
    </div>
<% end %>